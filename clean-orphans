#!/bin/bash

echo "ðŸ” Scanning for orphaned development processes..."

# 1. å°‹æ‰¾å®‰å…¨çš„å­¤å…’é€²ç¨‹ (PPID=1)
ORPHAN_PIDS=$(ps -eo ppid,pid,command | grep -E 'playwright-mcp|run-driver|context7|mobile-mcp|npm exec @playwright|npm exec @mobilenext|npm exec @upstash|flutter_tester|dart.*(tooling-daemon|devtools --machine|development-service)|log stream.*Runner' | grep -v grep | awk '$1 == 1 {print $2}')
ADB_PIDS=$(ps aux | grep -E 'adb.*logcat' | grep -v grep | awk '{print $2}')

# åˆä½µéœ€è¦å®‰å…¨æ¸…ç†çš„ PID
PIDS_TO_KILL=""
[ -n "$ORPHAN_PIDS" ] && PIDS_TO_KILL="$ORPHAN_PIDS"
[ -n "$ADB_PIDS" ] && PIDS_TO_KILL="$PIDS_TO_KILL $ADB_PIDS"
PIDS_TO_KILL=$(echo "$PIDS_TO_KILL" | xargs)

if [ -n "$PIDS_TO_KILL" ]; then
    STATS=$(ps -o rss= -p $PIDS_TO_KILL 2>/dev/null | awk '{sum+=$1; count++} END {printf "%d|%.2f", count, sum/1024}')
    COUNT=$(echo "$STATS" | cut -d'|' -f1)
    MEM=$(echo "$STATS" | cut -d'|' -f2)
    
    echo "ðŸ”ª Killing $COUNT orphaned/stale processes (Reclaiming ~$MEM MB)..."
    echo "$PIDS_TO_KILL" | xargs kill 2>/dev/null
    echo "âœ… Safe orphans cleaned."
else
    echo "âœ… No safe orphans found. Clean!"
fi

# 2. æ·±åº¦æ¸…ç†æ¨¡å¼
if [ "$1" == "--deep" ]; then
    echo ""
    echo "âš ï¸ Deep cleanup requested..."
    
    # å»ºç«‹ä¸€å€‹å‡½å¼ä¾†è¨ˆç®—å’Œæ¸…ç†ç‰¹å®šé—œéµå­—çš„é€²ç¨‹
    cleanup_by_name() {
        local name=$1
        local label=$2
        local pattern=$3
        
        local PIDS=$(ps aux | grep -E "$pattern" | grep -v grep | awk '{print $2}' | xargs)
        if [ -n "$PIDS" ]; then
            local STATS=$(ps -o rss= -p $PIDS 2>/dev/null | awk '{sum+=$1; count++} END {printf "%d|%.2f", count, sum/1024}')
            local COUNT=$(echo "$STATS" | cut -d'|' -f1)
            local MEM=$(echo "$STATS" | cut -d'|' -f2)
            echo "ðŸ”ª Killing $COUNT $label processes (Reclaiming ~$MEM MB)..."
            echo "$PIDS" | xargs kill 2>/dev/null
        else
            echo "âœ… No $label processes found."
        fi
    }

    # åŸ·è¡Œå„é …æ·±åº¦æ¸…ç†
    cleanup_by_name "kotlinLsp" "Kotlin LSP" "kotlinLsp"
    cleanup_by_name "gradle" "Gradle Daemon" "org.gradle.launcher.daemon"
    cleanup_by_name "flutter_daemon" "Flutter Daemon" "flutter_tools.snapshot daemon"
    cleanup_by_name "xcodebuild" "Stuck xcodebuild" "xcodebuild"
    
    # macOS å°ˆç”¨çš„ iOS æ¨¡æ“¬å™¨æ¸…ç†
    if command -v xcrun &> /dev/null; then
        SIM_PIDS=$(ps aux | grep -E 'CoreSimulator|Simulator.app' | grep -v grep | awk '{print $2}' | xargs)
        if [ -n "$SIM_PIDS" ]; then
            S_STATS=$(ps -o rss= -p $SIM_PIDS 2>/dev/null | awk '{sum+=$1; count++} END {printf "%d|%.2f", count, sum/1024}')
            S_COUNT=$(echo "$S_STATS" | cut -d'|' -f1)
            S_MEM=$(echo "$S_STATS" | cut -d'|' -f2)
            echo "ðŸ”ª Shutting down iOS Simulators ($S_COUNT processes, Reclaiming ~$S_MEM MB)..."
            xcrun simctl shutdown all 2>/dev/null
        else
            echo "âœ… No iOS Simulator processes found."
        fi
    fi
    
    echo "âœ… Deep cleanup completed."
else
    echo ""
    echo "ðŸ’¡ Tip: Run 'clean-orphans --deep' to also kill Kotlin LSP, Gradle Daemons, and iOS Simulators."
fi
